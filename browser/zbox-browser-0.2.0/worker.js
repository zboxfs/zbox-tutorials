!function(e){self.webpackChunk=function(r,a){for(var n in a)e[n]=a[n];for(;r.length;)t[r.pop()]=1};var r={},t={0:1},a={};var n={5:function(){return{"./zbox_wasm.js":{__wbindgen_object_drop_ref:function(e){return r[3].exports.__wbindgen_object_drop_ref(e)},__wbindgen_string_new:function(e,t){return r[3].exports.__wbindgen_string_new(e,t)},__wbindgen_json_parse:function(e,t){return r[3].exports.__wbindgen_json_parse(e,t)},__wbg_contains_a441a63bfdfbf56b:function(e,t){return r[3].exports.__wbg_contains_a441a63bfdfbf56b(e,t)},__wbg_insert_9f4f4189898136d3:function(e,t,a){return r[3].exports.__wbg_insert_9f4f4189898136d3(e,t,a)},__wbg_remove_c8ea50ae95b9837f:function(e,t){return r[3].exports.__wbg_remove_c8ea50ae95b9837f(e,t)},__wbg_clear_becb14ee647153dc:function(){return r[3].exports.__wbg_clear_becb14ee647153dc()},__wbg_get_0b8d6a5578871568:function(e,t){return r[3].exports.__wbg_get_0b8d6a5578871568(e,t)},__wbindgen_is_undefined:function(e){return r[3].exports.__wbindgen_is_undefined(e)},__wbg_log_752412b34bee8ef1:function(e,t,a,n,s,o,i,l){return r[3].exports.__wbg_log_752412b34bee8ef1(e,t,a,n,s,o,i,l)},__widl_f_get_random_values_with_u8_array_Crypto:function(e,t,a){return r[3].exports.__widl_f_get_random_values_with_u8_array_Crypto(e,t,a)},__widl_instanceof_WorkerGlobalScope:function(e){return r[3].exports.__widl_instanceof_WorkerGlobalScope(e)},__widl_f_crypto_WorkerGlobalScope:function(e){return r[3].exports.__widl_f_crypto_WorkerGlobalScope(e)},__widl_f_new_XMLHttpRequest:function(){return r[3].exports.__widl_f_new_XMLHttpRequest()},__widl_f_get_all_response_headers_XMLHttpRequest:function(e,t){return r[3].exports.__widl_f_get_all_response_headers_XMLHttpRequest(e,t)},__widl_f_open_with_async_XMLHttpRequest:function(e,t,a,n,s,o){return r[3].exports.__widl_f_open_with_async_XMLHttpRequest(e,t,a,n,s,o)},__widl_f_send_XMLHttpRequest:function(e){return r[3].exports.__widl_f_send_XMLHttpRequest(e)},__widl_f_send_with_opt_buffer_source_XMLHttpRequest:function(e,t){return r[3].exports.__widl_f_send_with_opt_buffer_source_XMLHttpRequest(e,t)},__widl_f_set_request_header_XMLHttpRequest:function(e,t,a,n,s){return r[3].exports.__widl_f_set_request_header_XMLHttpRequest(e,t,a,n,s)},__widl_f_ready_state_XMLHttpRequest:function(e){return r[3].exports.__widl_f_ready_state_XMLHttpRequest(e)},__widl_f_set_timeout_XMLHttpRequest:function(e,t){return r[3].exports.__widl_f_set_timeout_XMLHttpRequest(e,t)},__widl_f_set_with_credentials_XMLHttpRequest:function(e,t){return r[3].exports.__widl_f_set_with_credentials_XMLHttpRequest(e,t)},__widl_f_status_XMLHttpRequest:function(e){return r[3].exports.__widl_f_status_XMLHttpRequest(e)},__widl_f_set_response_type_XMLHttpRequest:function(e,t){return r[3].exports.__widl_f_set_response_type_XMLHttpRequest(e,t)},__widl_f_response_XMLHttpRequest:function(e){return r[3].exports.__widl_f_response_XMLHttpRequest(e)},__wbg_call_836fa928f74337e5:function(e,t){return r[3].exports.__wbg_call_836fa928f74337e5(e,t)},__wbindgen_object_clone_ref:function(e){return r[3].exports.__wbindgen_object_clone_ref(e)},__wbg_newnoargs_8d1797b163dbc9fb:function(e,t){return r[3].exports.__wbg_newnoargs_8d1797b163dbc9fb(e,t)},__wbg_now_d9ff59a9d063f1ca:function(){return r[3].exports.__wbg_now_d9ff59a9d063f1ca()},__wbg_buffer_e04d67bf3bf41917:function(e){return r[3].exports.__wbg_buffer_e04d67bf3bf41917(e)},__wbg_newwithbyteoffsetandlength_9cfc37146f8a28ba:function(e,t,a){return r[3].exports.__wbg_newwithbyteoffsetandlength_9cfc37146f8a28ba(e,t,a)},__wbg_length_cfa4a8dd9fc9bbfc:function(e){return r[3].exports.__wbg_length_cfa4a8dd9fc9bbfc(e)},__wbg_new_c745db9584dd061d:function(e){return r[3].exports.__wbg_new_c745db9584dd061d(e)},__wbg_set_2cce886d07c10f52:function(e,t,a){return r[3].exports.__wbg_set_2cce886d07c10f52(e,t,a)},__wbg_newwithbyteoffset_a1c84abd181cbef3:function(e,t){return r[3].exports.__wbg_newwithbyteoffset_a1c84abd181cbef3(e,t)},__wbg_subarray_07f305e5e1d4da82:function(e,t,a){return r[3].exports.__wbg_subarray_07f305e5e1d4da82(e,t,a)},__wbg_slice_983de3d1d0239bb6:function(e,t,a){return r[3].exports.__wbg_slice_983de3d1d0239bb6(e,t,a)},__wbg_byteLength_0d95096ad2ff9f80:function(e){return r[3].exports.__wbg_byteLength_0d95096ad2ff9f80(e)},__wbindgen_debug_string:function(e,t){return r[3].exports.__wbindgen_debug_string(e,t)},__wbindgen_throw:function(e,t){return r[3].exports.__wbindgen_throw(e,t)},__wbindgen_rethrow:function(e){return r[3].exports.__wbindgen_rethrow(e)},__wbindgen_memory:function(){return r[3].exports.__wbindgen_memory()}}}}};function s(t){if(r[t])return r[t].exports;var a=r[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.e=function(e){var r=[];return r.push(Promise.resolve().then(function(){t[e]||importScripts(e+".worker.js")})),({1:[5]}[e]||[]).forEach(function(e){var t=a[e];if(t)r.push(t);else{var o,i=n[e](),l=fetch(s.p+""+{5:"79e4f62cd0e5f17042b8"}[e]+".module.wasm");if(i instanceof Promise&&"function"==typeof WebAssembly.compileStreaming)o=Promise.all([WebAssembly.compileStreaming(l),i]).then(function(e){return WebAssembly.instantiate(e[0],e[1])});else if("function"==typeof WebAssembly.instantiateStreaming)o=WebAssembly.instantiateStreaming(l,i);else{o=l.then(function(e){return e.arrayBuffer()}).then(function(e){return WebAssembly.instantiate(e,i)})}r.push(a[e]=o.then(function(r){return s.w[e]=(r.instance||r).exports}))}}),Promise.all(r)},s.m=e,s.c=r,s.d=function(e,r,t){s.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:t})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,r){if(1&r&&(e=s(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(s.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var a in e)s.d(t,a,function(r){return e[r]}.bind(null,a));return t},s.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(r,"a",r),r},s.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},s.p="",s.w={},s(s.s=2)}([function(e,r,t){"use strict";t.d(r,"b",function(){return _}),t.d(r,"a",function(){return u});const a=1,n=2,s=3,o=4,i=5,l=99;function c(e,r,t){postMessage({scope:"log",level:e,msg:`${r}`,from:t||"worker.js"})}let _=new class{constructor(e){this.level=e||o}setLevel(e){switch(e){case"trace":return this.level=a,e;case"debug":return this.level=n,e;case"info":return this.level=s,e;case"warn":return this.level=o,e;case"error":return this.level=i,e;case"off":return this.level=l,e;default:return this.level=o,"warn"}}trace(e,r){this.level<=a&&c("trace",e,r)}debug(e,r){this.level<=n&&c("debug",e,r)}info(e,r){this.level<=s&&c("info",e,r)}warn(e,r){this.level<=o&&c("warn",e,r)}error(e,r){this.level<=i&&c("error",e,r)}};function u(e,r,t,a){const n=r.lastIndexOf("/src/"),s=`${r.substring(n+5)}:${t}`;switch(e){case"ERROR":_.error(a,s);break;case"WARN":_.warn(a,s);break;case"INFO":_.info(a,s);break;case"DEBUG":_.debug(a,s);break;case"TRACE":_.trace(a,s)}}},function(e,r,t){"use strict";const a=1,n=2,s=3,o=4,i=5,l=99,c="color: white; padding: 0 3px; width: 4em; display: inline-block; text-align: center; background: ",_={lvl:{error:c+"darkred",warn:c+"orange",info:c+"green",debug:c+"blue",trace:c+"gray"},loc:"font-weight: bold; color: inherit; opacity: 0.5;",msg:"background: inherit; color: inherit"};function u(e,r,t){const a=`[%c${e}%c ${t||"index.js"}%c] ${r}`;let n;switch(e){case"trace":n=console.log;break;case"debug":n=console.debug;break;case"info":n=console.info;break;case"warn":n=console.warn;break;case"error":n=console.error;break;default:n=console.log}n(a,_.lvl[e],_.loc,_.msg)}let p=new class{constructor(){this.level=o,this.output=null}config(e){let r=e||{};switch(r.level||"warn"){case"trace":this.level=a;break;case"debug":this.level=n;break;case"info":this.level=s;break;case"warn":this.level=o;break;case"error":this.level=i;break;case"off":this.level=l;break;default:this.level=o}this.output=r.logger||u}trace(e,r){this.level<=a&&this.output("trace",e,r)}debug(e,r){this.level<=n&&this.output("debug",e,r)}info(e,r){this.level<=s&&this.output("info",e,r)}warn(e,r){this.level<=o&&this.output("warn",e,r)}error(e,r){this.level<=i&&this.output("error",e,r)}};t.d(r,"a",function(){return d}),t.d(r,"c",function(){return m}),t.d(r,"d",function(){return b}),t.d(r,"e",function(){return g}),t.d(r,"f",function(){return w}),t.d(r,"b",function(){return h});const f="zbox_local_cache";let d=new class{constructor(){this.db=null,this.storeName=null,this.map=new Map,this.dbClosed=!0}open(e){let r=this;return function(e){return new Promise((r,t)=>{const a=Math.floor(Date.now()/1e3);let n=indexedDB.open(f,a);n.onerror=(e=>{t("IndexedDB is forbidden to use")}),n.onupgradeneeded=(r=>{let t=r.target.result;t.objectStoreNames.contains(e)||t.createObjectStore(e,{keyPath:"relPath"})}),n.onsuccess=(e=>{r(e.target.result)})})}(e).then(t=>(r.db=t,r.storeName=e,new Promise((t,a)=>{let n=r.db.transaction(e,"readonly").objectStore(e).getAll();n.onerror=(e=>{a("Database error: "+e.target.errorCode)}),n.onsuccess=(e=>{let a=e.target.result;a.forEach(e=>{r.map.set(e.relPath,e.data)}),p.debug(`Cache backend opened: ${a.length} cache items loaded`),r.dbClosed=!1,t()})})))}immediateClose(){this.dbClosed||(this.db.close(),this.storeName=null,this.map.clear(),this.dbClosed=!0)}close(){let e=this;return e.dbClosed?Promise.resolve():new Promise((r,t)=>{let a=e.db.transaction(e.storeName,"readwrite");a.onabort=(r=>{e.map.clear(),t("Database tx aborted: "+r.target.errorCode)}),a.onerror=(r=>{e.map.clear(),t("Database tx error: "+r.target.errorCode)}),a.oncomplete=(t=>{e.map.clear(),e.dbClosed=!0,r()});let n=a.objectStore(e.storeName);n.clear(),e.map.forEach((e,r)=>{n.put({relPath:r,data:e})}),e.db.close()})}contains(e){return this.map.has(e)}get(e){return this.map.get(e)}insert(e,r){this.map.set(e,r)}remove(e){this.map.delete(e)}clear(){this.map.clear(),this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).clear().onerror=(e=>{p.error("Clear local cache failed "+e.target.errorCode)})}destroy(e){return function(e){return new Promise((r,t)=>{const a=Math.floor(Date.now()/1e3);let n=indexedDB.open(f,a);n.onerror=(e=>{t("IndexedDB is forbidden to use")}),n.onupgradeneeded=(t=>{let a=t.target.result;a.objectStoreNames.contains(e)&&a.deleteObjectStore(e),r()}),n.onsuccess=(e=>{e.target.result.close()})})}(e)}};function m(e){return d.contains(e)}function b(e){return d.get(e)}function g(e,r){d.insert(e,r.slice())}function w(e){d.remove(e)}function h(){d.clear()}},function(e,r,t){"use strict";t.r(r);var a={zbox:{initEnv:{name:"initEnv",arg:[{debug:{type:"boolean",optional:!0}}],optional:!0},version:{name:"version",arg:[]},exists:{name:"exists",arg:["string"]},openRepo:{name:"openRepo",arg:[{uri:{type:"string"},pwd:{type:"string"},opts:{type:"object",optional:!0}}]},repairSuperBlock:{name:"repairSuperBlock",arg:[{uri:{type:"string"},pwd:{type:"string"}}]}},repo:{close:{name:"close",arg:[]},info:{name:"info",arg:[]},resetPassword:{name:"resetPassword",arg:[{oldPwd:{type:"string"}},{newPwd:{type:"string"}}]},pathExists:{name:"pathExists",arg:["string"]},isFile:{name:"isFile",arg:["string"]},isDir:{name:"isDir",arg:["string"]},createFile:{name:"createFile",arg:["string"]},openFile:{name:"openFile",arg:["string",{path:{type:"boolean"},opts:{type:"object",optional:!0}}]},createDir:{name:"createDir",arg:["string"]},createDirAll:{name:"createDirAll",arg:["string"]},readDir:{name:"readDir",arg:["string"]},metadata:{name:"metadata",arg:["string"]},history:{name:"history",arg:["string"]},copy:{name:"copy",arg:[{from:{type:"string"}},{to:{type:"string"}}]},removeFile:{name:"removeFile",arg:["string"]},removeDir:{name:"removeDir",arg:["string"]},removeDirAll:{name:"removeDirAll",arg:["string"]},rename:{name:"rename",arg:[{from:{type:"string"}},{to:{type:"string"}}]}},file:{close:{name:"close",arg:[]},read:{name:"read",arg:["buffer"]},readAll:{name:"readAll",arg:[]},readAllString:{name:"readAllString",arg:[]},write:{name:"write",arg:["string","buffer"]},finish:{name:"finish",arg:[]},writeOnce:{name:"writeOnce",arg:["string","buffer"]},seek:{name:"seek",arg:[{from:{type:"number"},offset:{type:"number"}}]},setLen:{name:"setLen",arg:["number"]},currVersion:{name:"currVersion",arg:[]},metadata:{name:"metadata",arg:[]},history:{name:"history",arg:[]},versionReader:{name:"versionReader",arg:["number"]}},versionReader:{close:{name:"close",arg:[]},read:{name:"read",arg:["buffer"]},readAll:{name:"readAll",arg:[]},readAllString:{name:"readAllString",arg:[]},seek:{name:"seek",arg:[{from:{type:"number"},offset:{type:"number"}}]}}},n=t(0),s=t(1);function o(e){return String.fromCharCode.apply(null,new Uint16Array(e))}function i(e){if("string"!=typeof e)throw"Wrong argument, string required"}function l(e,r){if("string"!=typeof e||"string"!=typeof r)throw"Wrong argument, string required"}function c(e){if(!Number.isInteger(e)||e<0)throw"Wrong argument, positive integer required"}function _(e){if(!Number.isInteger(e))throw"Wrong argument, integer required"}let u=null,p=null,f={files:{},vrdrs:{}};onmessage=function(e){let r=e.data;r.result=null,r.error=null;const d=a[r.scope];try{switch(r.scope){case"zbox":!function(e,r){switch(e.type){case r.initEnv.name:{let r=n.b.setLevel(e.params&&e.params.log?e.params.log.level:"warn");return void t.e(1).then(t.bind(null,3)).then(e=>{(u=e).init_env(r)}).catch(r=>{n.b.error(`load ZboxFS wasm failed: ${r}`),e.error=`${r}`}).finally(()=>postMessage(e))}case r.version.name:e.result=u.zbox_version(),postMessage(e);break;case r.exists.name:return i(e.params),e.result=u.Repo.exists(e.params),void postMessage(e);case r.openRepo.name:{l(e.params.uri,e.params.pwd);const r=function(e){const r=/^zbox:\/\/\w+@(\w+)/.exec(e);if(!r)throw"Invalid Uri";return r[1]}(e.params.uri);let t;return void(t="mem"===function(e){const r=/^zbox:\/\/\w+@\w+\?.*cache_type=(\w+).*/.exec(e);return r?r[1]:void 0}(e.params.uri)?Promise.resolve():s.a.open(r)).then(()=>{let r=new u.RepoOpener,t=e.params.opts||{};t.hasOwnProperty("create")&&r.create(t.create),t.hasOwnProperty("createNew")&&r.createNew(t.createNew),t.hasOwnProperty("compress")&&r.compress(t.compress),t.hasOwnProperty("versionLimit")&&r.versionLimit(t.versionLimit),t.hasOwnProperty("dedupChunk")&&r.dedupChunk(t.dedupChunk),t.hasOwnProperty("readOnly")&&r.readOnly(t.readOnly),p=r.open(e.params.uri,e.params.pwd)}).catch(r=>{n.b.error(`open repo failed: ${r}`),e.error=`${r}`,s.a.immediateClose()}).finally(()=>postMessage(e))}case r.repairSuperBlock.name:l(e.params.uri,e.params.pwd),u.Repo.repairSuperBlock(e.params.uri,e.params.pwd),postMessage(e)}}(r,d);break;case"repo":!function(e,r){switch(e.type){case r.close.name:{let r=Object.keys(f.files).length;return r>0&&n.b.warn(`${r} file(s) still opened when close repo`),(r=Object.keys(f.vrdrs).length)>0&&n.b.warn(`${r} version reader(s) still opened when close repo`),p.close(),void s.a.close().catch(r=>{n.b.error(`close local cache failed: ${r}`),e.error=`${r}`}).finally(()=>postMessage(e))}case r.info.name:e.result=p.info();break;case r.resetPassword.name:l(e.params.oldPwd,e.params.newPwd),p.resetPassword(e.params.oldPwd,e.params.newPwd);break;case r.pathExists.name:i(e.params),e.result=p.pathExists(e.params);break;case r.isFile.name:i(e.params),e.result=p.isFile(e.params);break;case r.isDir.name:i(e.params),e.result=p.isDir(e.params);break;case r.createFile.name:{i(e.params);let r=p.createFile(e.params);f.files[r.ptr]=r,e.result=r.ptr;break}case r.openFile.name:{let r;if("string"==typeof e.params)r=p.openFile(e.params);else{if(null===(t=e.params)||"object"!=typeof t)throw"Wrong argument, string or Object required";{i(e.params.path);let t=new u.OpenOptions,a=e.params.opts||{};a.hasOwnProperty("read")&&t.read(a.read),a.hasOwnProperty("write")&&t.write(a.write),a.hasOwnProperty("append")&&t.append(a.append),a.hasOwnProperty("truncate")&&t.truncate(a.truncate),a.hasOwnProperty("create")&&t.create(a.create),a.hasOwnProperty("createNew")&&t.createNew(a.createNew),a.hasOwnProperty("versionLimit")&&t.versionLimit(a.versionLimit),a.hasOwnProperty("dedupChunk")&&t.dedupChunk(a.dedupChunk),r=t.open(p,e.params.path)}}f.files[r.ptr]=r,e.result=r.ptr;break}case r.createDir.name:i(e.params),p.createDir(e.params);break;case r.createDirAll.name:i(e.params),p.createDirAll(e.params);break;case r.readDir.name:i(e.params),e.result=p.readDir(e.params);break;case r.metadata.name:i(e.params),e.result=p.metadata(e.params);break;case r.history.name:i(e.params),e.result=p.history(e.params);break;case r.copy.name:l(e.params.from,e.params.to),p.copy(e.params.from,e.params.to);break;case r.removeFile.name:i(e.params),p.removeFile(e.params);break;case r.removeDir.name:i(e.params),p.removeDir(e.params);break;case r.removeDirAll.name:i(e.params),p.removeDirAll(e.params);break;case r.rename.name:l(e.params.from,e.params.to),p.rename(e.params.from,e.params.to)}var t;postMessage(e)}(r,d);break;case"file":!function(e,r){let t=f.files[e.object];if(void 0===t)throw"File not opened";let a=null;switch(e.type){case r.close.name:t.close(),delete f.files[e.object];break;case r.read.name:{let r=new Uint8Array(e.params.buf,e.params.offset,e.params.len);const n=t.read(r);e.result={buf:e.params.buf,offset:e.params.offset,len:n},a=[e.params.buf];break}case r.readAll.name:{let r=t.readAll();e.result=r.buffer,a=[r.buffer];break}case r.readAllString.name:{let r=t.readAll();e.result=o(r.buffer);break}case r.write.name:{const r=new Uint8Array(e.params.buf,e.params.offset,e.params.len);e.result=t.write(r);break}case r.finish.name:t.finish();break;case r.writeOnce.name:{const r=new Uint8Array(e.params.buf,e.params.offset,e.params.len);e.result=t.writeOnce(r);break}case r.seek.name:c(e.params.from),_(e.params.offset),e.result=t.seek(e.params.from,e.params.offset);break;case r.setLen.name:c(e.params),t.setLen(e.params);break;case r.currVersion.name:e.result=t.currVersion();break;case r.metadata.name:e.result=t.metadata();break;case r.history.name:e.result=t.history();break;case r.versionReader.name:{c(e.params);const r=t.versionReader(e.params);f.vrdrs[r.ptr]=r,e.result=r.ptr;break}}a?postMessage(e,a):postMessage(e)}(r,d);break;case"versionReader":!function(e,r){let t=f.vrdrs[e.object];if(null==t)throw"Version reader is closed";let a=null;switch(e.type){case r.close.name:t.close(),delete f.vrdrs[e.object];break;case r.read.name:{let r=new Uint8Array(e.params.buf,e.params.offset,e.params.len);const n=t.read(r);e.result={buf:e.params.buf,offset:e.params.offset,len:n},a=[e.params.buf];break}case r.readAll.name:{let r=t.readAll();e.result=r.buffer,a=[r.buffer];break}case r.readAllString.name:{let r=t.readAll();e.result=o(r.buffer);break}case r.seek.name:c(e.params.from),_(e.params.offset),e.result=t.seek(e.params.from,e.params.offset)}a?postMessage(e,a):postMessage(e)}(r,d)}}catch(e){n.b.error(e),r.error=`${e}`,postMessage(r)}}}]);
//# sourceMappingURL=worker.js.map