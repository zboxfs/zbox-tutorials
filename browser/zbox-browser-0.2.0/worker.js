!function(e){self.webpackChunk=function(r,a){for(var n in a)e[n]=a[n];for(;r.length;)t[r.pop()]=1};var r={},t={0:1},a={};var n={5:function(){return{"./zbox":{__wbindgen_object_drop_ref:function(e){return r[3].exports.__wbindgen_object_drop_ref(e)},__wbg_get_270d372edb76a021:function(e,t){return r[3].exports.__wbg_get_270d372edb76a021(e,t)},__wbindgen_is_undefined:function(e){return r[3].exports.__wbindgen_is_undefined(e)},__wbg_contains_e2e45ee10237db57:function(e,t){return r[3].exports.__wbg_contains_e2e45ee10237db57(e,t)},__wbg_insert_38da78f9c0cb0595:function(e,t,a){return r[3].exports.__wbg_insert_38da78f9c0cb0595(e,t,a)},__wbg_remove_61a961fdaa9df3b0:function(e,t){return r[3].exports.__wbg_remove_61a961fdaa9df3b0(e,t)},__wbindgen_string_new:function(e,t){return r[3].exports.__wbindgen_string_new(e,t)},__wbindgen_json_parse:function(e,t){return r[3].exports.__wbindgen_json_parse(e,t)},__widl_f_debug_4_:function(e,t,a,n){return r[3].exports.__widl_f_debug_4_(e,t,a,n)},__widl_f_error_1_:function(e){return r[3].exports.__widl_f_error_1_(e)},__widl_f_error_4_:function(e,t,a,n){return r[3].exports.__widl_f_error_4_(e,t,a,n)},__widl_f_info_4_:function(e,t,a,n){return r[3].exports.__widl_f_info_4_(e,t,a,n)},__widl_f_log_4_:function(e,t,a,n){return r[3].exports.__widl_f_log_4_(e,t,a,n)},__widl_f_warn_4_:function(e,t,a,n){return r[3].exports.__widl_f_warn_4_(e,t,a,n)},__widl_f_get_random_values_with_u8_array_Crypto:function(e,t,a,n){return r[3].exports.__widl_f_get_random_values_with_u8_array_Crypto(e,t,a,n)},__widl_instanceof_WorkerGlobalScope:function(e){return r[3].exports.__widl_instanceof_WorkerGlobalScope(e)},__widl_f_crypto_WorkerGlobalScope:function(e,t){return r[3].exports.__widl_f_crypto_WorkerGlobalScope(e,t)},__widl_f_new_XMLHttpRequest:function(e){return r[3].exports.__widl_f_new_XMLHttpRequest(e)},__widl_f_get_all_response_headers_XMLHttpRequest:function(e,t,a){return r[3].exports.__widl_f_get_all_response_headers_XMLHttpRequest(e,t,a)},__widl_f_open_with_async_XMLHttpRequest:function(e,t,a,n,s,o,i){return r[3].exports.__widl_f_open_with_async_XMLHttpRequest(e,t,a,n,s,o,i)},__widl_f_send_XMLHttpRequest:function(e,t){return r[3].exports.__widl_f_send_XMLHttpRequest(e,t)},__widl_f_send_with_opt_buffer_source_XMLHttpRequest:function(e,t,a){return r[3].exports.__widl_f_send_with_opt_buffer_source_XMLHttpRequest(e,t,a)},__widl_f_set_request_header_XMLHttpRequest:function(e,t,a,n,s,o){return r[3].exports.__widl_f_set_request_header_XMLHttpRequest(e,t,a,n,s,o)},__widl_f_ready_state_XMLHttpRequest:function(e){return r[3].exports.__widl_f_ready_state_XMLHttpRequest(e)},__widl_f_set_timeout_XMLHttpRequest:function(e,t){return r[3].exports.__widl_f_set_timeout_XMLHttpRequest(e,t)},__widl_f_set_with_credentials_XMLHttpRequest:function(e,t){return r[3].exports.__widl_f_set_with_credentials_XMLHttpRequest(e,t)},__widl_f_status_XMLHttpRequest:function(e,t){return r[3].exports.__widl_f_status_XMLHttpRequest(e,t)},__widl_f_set_response_type_XMLHttpRequest:function(e,t){return r[3].exports.__widl_f_set_response_type_XMLHttpRequest(e,t)},__widl_f_response_XMLHttpRequest:function(e,t){return r[3].exports.__widl_f_response_XMLHttpRequest(e,t)},__wbg_newnoargs_a172f39151049128:function(e,t){return r[3].exports.__wbg_newnoargs_a172f39151049128(e,t)},__wbg_call_8a9c8b0a32a202ff:function(e,t,a){return r[3].exports.__wbg_call_8a9c8b0a32a202ff(e,t,a)},__wbg_now_307a67b1c1d8ca31:function(){return r[3].exports.__wbg_now_307a67b1c1d8ca31()},__wbg_buffer_0b401f8e593a961e:function(e){return r[3].exports.__wbg_buffer_0b401f8e593a961e(e)},__wbg_newwithbyteoffsetandlength_533a05dbfbcbee36:function(e,t,a){return r[3].exports.__wbg_newwithbyteoffsetandlength_533a05dbfbcbee36(e,t,a)},__wbg_length_7b1c5e3634bc9051:function(e){return r[3].exports.__wbg_length_7b1c5e3634bc9051(e)},__wbg_new_662b0aa231e9b27c:function(e){return r[3].exports.__wbg_new_662b0aa231e9b27c(e)},__wbg_set_55ad9d0789844e32:function(e,t,a){return r[3].exports.__wbg_set_55ad9d0789844e32(e,t,a)},__wbg_newwithbyteoffset_74477be1525e8d20:function(e,t){return r[3].exports.__wbg_newwithbyteoffset_74477be1525e8d20(e,t)},__wbg_subarray_9cc4d5558c9dcf2a:function(e,t,a){return r[3].exports.__wbg_subarray_9cc4d5558c9dcf2a(e,t,a)},__wbg_slice_cf1634eadc553398:function(e,t,a){return r[3].exports.__wbg_slice_cf1634eadc553398(e,t,a)},__wbg_byteLength_50d6b93074b674b7:function(e){return r[3].exports.__wbg_byteLength_50d6b93074b674b7(e)},__wbindgen_object_clone_ref:function(e){return r[3].exports.__wbindgen_object_clone_ref(e)},__wbindgen_debug_string:function(e,t){return r[3].exports.__wbindgen_debug_string(e,t)},__wbindgen_throw:function(e,t){return r[3].exports.__wbindgen_throw(e,t)},__wbindgen_rethrow:function(e){return r[3].exports.__wbindgen_rethrow(e)},__wbindgen_memory:function(){return r[3].exports.__wbindgen_memory()}},"../cache_backend":{clear:function(){return r[1].exports.b()}}}}};function s(t){if(r[t])return r[t].exports;var a=r[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.e=function(e){var r=[];return r.push(Promise.resolve().then(function(){t[e]||importScripts(e+".worker.js")})),({1:[5]}[e]||[]).forEach(function(e){var t=a[e];if(t)r.push(t);else{var o,i=n[e](),_=fetch(s.p+""+{5:"c6ec55d439115bc56b88"}[e]+".module.wasm");if(i instanceof Promise&&"function"==typeof WebAssembly.compileStreaming)o=Promise.all([WebAssembly.compileStreaming(_),i]).then(function(e){return WebAssembly.instantiate(e[0],e[1])});else if("function"==typeof WebAssembly.instantiateStreaming)o=WebAssembly.instantiateStreaming(_,i);else{o=_.then(function(e){return e.arrayBuffer()}).then(function(e){return WebAssembly.instantiate(e,i)})}r.push(a[e]=o.then(function(r){return s.w[e]=(r.instance||r).exports}))}}),Promise.all(r)},s.m=e,s.c=r,s.d=function(e,r,t){s.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:t})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,r){if(1&r&&(e=s(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(s.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var a in e)s.d(t,a,function(r){return e[r]}.bind(null,a));return t},s.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(r,"a",r),r},s.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},s.p="",s.w={},s(s.s=2)}([function(e,r,t){"use strict";t.d(r,"a",function(){return l});const a=1,n=2,s=3,o=4,i=5,_=99;let l=new class{constructor(e){this.level=e||o}setLevel(e){switch(e){case"trace":return this.level=a,e;case"debug":return this.level=n,e;case"info":return this.level=s,e;case"warn":return this.level=o,e;case"error":return this.level=i,e;case"off":return this.level=_,e;default:return this.level=o,"warn"}}trace(e){this.level<=a&&console.log(e)}debug(e){this.level<=n&&console.debug(e)}info(e){this.level<=s&&console.info(e)}warn(e){this.level<=o&&console.warn(e)}error(e){this.level<=i&&console.error(e)}}},function(e,r,t){"use strict";t.d(r,"a",function(){return s}),t.d(r,"c",function(){return o}),t.d(r,"d",function(){return i}),t.d(r,"e",function(){return _}),t.d(r,"f",function(){return l}),t.d(r,"b",function(){return c});var a=t(0);const n="zbox_local_cache";let s=new class{constructor(){this.db=null,this.storeName=null,this.map=new Map,this.dbClosed=!0}open(e){let r=this;return function(e){return new Promise((r,t)=>{const a=Math.floor(Date.now()/1e3);let s=indexedDB.open(n,a);s.onerror=(e=>{t("IndexedDB is forbidden to use")}),s.onupgradeneeded=(r=>{let t=r.target.result;t.objectStoreNames.contains(e)||t.createObjectStore(e,{keyPath:"relPath"})}),s.onsuccess=(e=>{r(e.target.result)})})}(e).then(t=>(r.db=t,r.storeName=e,new Promise((t,n)=>{let s=r.db.transaction(e,"readonly").objectStore(e).getAll();s.onerror=(e=>{n("Database error: "+e.target.errorCode)}),s.onsuccess=(e=>{let n=e.target.result;n.forEach(e=>{r.map.set(e.relPath,e.data)}),a.a.debug(`Cache backend opened: ${n.length} cache items loaded`),r.dbClosed=!1,t()})})))}immediateClose(){this.dbClosed||(this.db.close(),this.storeName=null,this.map.clear(),this.dbClosed=!0)}close(){let e=this;return e.dbClosed?Promise.resolve():new Promise((r,t)=>{let a=e.db.transaction(e.storeName,"readwrite");a.onabort=(r=>{e.map.clear(),t("Database tx aborted: "+r.target.errorCode)}),a.onerror=(r=>{e.map.clear(),t("Database tx error: "+r.target.errorCode)}),a.oncomplete=(t=>{e.map.clear(),e.dbClosed=!0,r()});let n=a.objectStore(e.storeName);n.clear(),e.map.forEach((e,r)=>{n.put({relPath:r,data:e})}),e.db.close()})}contains(e){return this.map.has(e)}get(e){return this.map.get(e)}insert(e,r){this.map.set(e,r)}remove(e){this.map.delete(e)}clear(){this.map.clear(),this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).clear().onerror=(e=>{a.a.error("Clear local cache failed "+e.target.errorCode)})}destroy(e){return function(e){return new Promise((r,t)=>{const a=Math.floor(Date.now()/1e3);let s=indexedDB.open(n,a);s.onerror=(e=>{t("IndexedDB is forbidden to use")}),s.onupgradeneeded=(t=>{let a=t.target.result;a.objectStoreNames.contains(e)&&a.deleteObjectStore(e),r()}),s.onsuccess=(e=>{e.target.result.close()})})}(e)}};function o(e){return s.contains(e)}function i(e){return s.get(e)}function _(e,r){s.insert(e,r.slice())}function l(e){s.remove(e)}function c(){s.clear()}},function(e,r,t){"use strict";t.r(r);var a={zbox:{initEnv:{name:"initEnv",arg:[{debug:{type:"boolean",optional:!0}}],optional:!0},version:{name:"version",arg:[]},exists:{name:"exists",arg:["string"]},openRepo:{name:"openRepo",arg:[{uri:{type:"string"},pwd:{type:"string"},opts:{type:"object",optional:!0}}]},repairSuperBlock:{name:"repairSuperBlock",arg:[{uri:{type:"string"},pwd:{type:"string"}}]}},repo:{close:{name:"close",arg:[]},info:{name:"info",arg:[]},resetPassword:{name:"resetPassword",arg:[{oldPwd:{type:"string"}},{newPwd:{type:"string"}}]},pathExists:{name:"pathExists",arg:["string"]},isFile:{name:"isFile",arg:["string"]},isDir:{name:"isDir",arg:["string"]},createFile:{name:"createFile",arg:["string"]},openFile:{name:"openFile",arg:["string",{path:{type:"boolean"},opts:{type:"object",optional:!0}}]},createDir:{name:"createDir",arg:["string"]},createDirAll:{name:"createDirAll",arg:["string"]},readDir:{name:"readDir",arg:["string"]},metadata:{name:"metadata",arg:["string"]},history:{name:"history",arg:["string"]},copy:{name:"copy",arg:[{from:{type:"string"}},{to:{type:"string"}}]},removeFile:{name:"removeFile",arg:["string"]},removeDir:{name:"removeDir",arg:["string"]},removeDirAll:{name:"removeDirAll",arg:["string"]},rename:{name:"rename",arg:[{from:{type:"string"}},{to:{type:"string"}}]}},file:{close:{name:"close",arg:[]},read:{name:"read",arg:["buffer"]},readAll:{name:"readAll",arg:[]},readAllString:{name:"readAllString",arg:[]},write:{name:"write",arg:["string","buffer"]},finish:{name:"finish",arg:[]},writeOnce:{name:"writeOnce",arg:["string","buffer"]},seek:{name:"seek",arg:[{from:{type:"number"},offset:{type:"number"}}]},setLen:{name:"setLen",arg:["number"]},currVersion:{name:"currVersion",arg:[]},metadata:{name:"metadata",arg:[]},history:{name:"history",arg:[]},versionReader:{name:"versionReader",arg:["number"]}},versionReader:{close:{name:"close",arg:[]},read:{name:"read",arg:["buffer"]},readAll:{name:"readAll",arg:[]},readAllString:{name:"readAllString",arg:[]},seek:{name:"seek",arg:[{from:{type:"number"},offset:{type:"number"}}]}}},n=t(0),s=t(1);function o(e){return String.fromCharCode.apply(null,new Uint16Array(e))}function i(e){if("string"!=typeof e)throw"Wrong argument, string required"}function _(e,r){if("string"!=typeof e||"string"!=typeof r)throw"Wrong argument, string required"}function l(e){if(!Number.isInteger(e)||e<0)throw"Wrong argument, positive integer required"}function c(e){if(!Number.isInteger(e))throw"Wrong argument, integer required"}let u=null,p=null,f={files:{},vrdrs:{}};onmessage=function(e){let r=e.data;r.result=null,r.error=null;const d=a[r.scope];try{switch(r.scope){case"zbox":!function(e,r){switch(e.type){case r.initEnv.name:{let r=n.a.setLevel(e.params?e.params.logLevel:"warn");return void t.e(1).then(t.bind(null,3)).then(e=>{(u=e).init_env(r)}).catch(r=>{n.a.error(`Load ZboxFS wasm failed: ${r}`),e.error=r}).finally(()=>postMessage(e))}case r.version.name:e.result=u.zbox_version(),postMessage(e);break;case r.exists.name:return i(e.params),e.result=u.Repo.exists(e.params),void postMessage(e);case r.openRepo.name:{_(e.params.uri,e.params.pwd);const r=function(e){const r=/^zbox:\/\/\w+@(\w+)/.exec(e);if(!r)throw"Invalid Uri";return r[1]}(e.params.uri);let t;return void(t="mem"===function(e){const r=/^zbox:\/\/\w+@\w+\?.*cache_type=(\w+).*/.exec(e);return r?r[1]:void 0}(e.params.uri)?Promise.resolve():s.a.open(r)).then(()=>{let r=new u.RepoOpener,t=e.params.opts||{};t.hasOwnProperty("create")&&r.create(t.create),t.hasOwnProperty("createNew")&&r.createNew(t.createNew),t.hasOwnProperty("compress")&&r.compress(t.compress),t.hasOwnProperty("versionLimit")&&r.versionLimit(t.versionLimit),t.hasOwnProperty("dedupChunk")&&r.dedupChunk(t.dedupChunk),t.hasOwnProperty("readOnly")&&r.readOnly(t.readOnly),p=r.open(e.params.uri,e.params.pwd)}).catch(r=>{e.error=r.toString(),s.a.immediateClose()}).finally(()=>postMessage(e))}case r.repairSuperBlock.name:_(e.params.uri,e.params.pwd),u.Repo.repairSuperBlock(e.params.uri,e.params.pwd),postMessage(e)}}(r,d);break;case"repo":!function(e,r){switch(e.type){case r.close.name:{let r=Object.keys(f.files).length;return r>0&&n.a.warn(`${r} file(s) still opened when close repo`),(r=Object.keys(f.vrdrs).length)>0&&n.a.warn(`${r} version reader(s) still opened when close repo`),p.close(),void s.a.close().catch(r=>e.error=r).finally(()=>postMessage(e))}case r.info.name:e.result=p.info();break;case r.resetPassword.name:_(e.params.oldPwd,e.params.newPwd),p.resetPassword(e.params.oldPwd,e.params.newPwd);break;case r.pathExists.name:i(e.params),e.result=p.pathExists(e.params);break;case r.isFile.name:i(e.params),e.result=p.isFile(e.params);break;case r.isDir.name:i(e.params),e.result=p.isDir(e.params);break;case r.createFile.name:{i(e.params);let r=p.createFile(e.params);f.files[r.ptr]=r,e.result=r.ptr;break}case r.openFile.name:{let r;if("string"==typeof e.params)r=p.openFile(e.params);else{if(null===(t=e.params)||"object"!=typeof t)throw"Wrong argument, string or Object required";{i(e.params.path);let t=new u.OpenOptions,a=e.params.opts||{};a.hasOwnProperty("read")&&t.read(a.read),a.hasOwnProperty("write")&&t.write(a.write),a.hasOwnProperty("append")&&t.append(a.append),a.hasOwnProperty("truncate")&&t.truncate(a.truncate),a.hasOwnProperty("create")&&t.create(a.create),a.hasOwnProperty("createNew")&&t.createNew(a.createNew),a.hasOwnProperty("versionLimit")&&t.versionLimit(a.versionLimit),a.hasOwnProperty("dedupChunk")&&t.dedupChunk(a.dedupChunk),r=t.open(p,e.params.path)}}f.files[r.ptr]=r,e.result=r.ptr;break}case r.createDir.name:i(e.params),p.createDir(e.params);break;case r.createDirAll.name:i(e.params),p.createDirAll(e.params);break;case r.readDir.name:i(e.params),e.result=p.readDir(e.params);break;case r.metadata.name:i(e.params),e.result=p.metadata(e.params);break;case r.history.name:i(e.params),e.result=p.history(e.params);break;case r.copy.name:_(e.params.from,e.params.to),p.copy(e.params.from,e.params.to);break;case r.removeFile.name:i(e.params),p.removeFile(e.params);break;case r.removeDir.name:i(e.params),p.removeDir(e.params);break;case r.removeDirAll.name:i(e.params),p.removeDirAll(e.params);break;case r.rename.name:_(e.params.from,e.params.to),p.rename(e.params.from,e.params.to)}var t;postMessage(e)}(r,d);break;case"file":!function(e,r){let t=f.files[e.object];if(void 0===t)throw"File not opened";let a=null;switch(e.type){case r.close.name:t.close(),delete f.files[e.object];break;case r.read.name:{let r=new Uint8Array(e.params.buf,e.params.offset,e.params.len);const n=t.read(r);e.result={buf:e.params.buf,offset:e.params.offset,len:n},a=[e.params.buf];break}case r.readAll.name:{let r=t.readAll();e.result=r.buffer,a=[r.buffer];break}case r.readAllString.name:{let r=t.readAll();e.result=o(r.buffer);break}case r.write.name:{const r=new Uint8Array(e.params.buf,e.params.offset,e.params.len);e.result=t.write(r);break}case r.finish.name:t.finish();break;case r.writeOnce.name:{const r=new Uint8Array(e.params.buf,e.params.offset,e.params.len);e.result=t.writeOnce(r);break}case r.seek.name:l(e.params.from),c(e.params.offset),e.result=t.seek(e.params.from,e.params.offset);break;case r.setLen.name:l(e.params),t.setLen(e.params);break;case r.currVersion.name:e.result=t.currVersion();break;case r.metadata.name:e.result=t.metadata();break;case r.history.name:e.result=t.history();break;case r.versionReader.name:{l(e.params);const r=t.versionReader(e.params);f.vrdrs[r.ptr]=r,e.result=r.ptr;break}}a?postMessage(e,a):postMessage(e)}(r,d);break;case"versionReader":!function(e,r){let t=f.vrdrs[e.object];if(null==t)throw"Version reader is closed";let a=null;switch(e.type){case r.close.name:t.close(),delete f.vrdrs[e.object];break;case r.read.name:{let r=new Uint8Array(e.params.buf,e.params.offset,e.params.len);const n=t.read(r);e.result={buf:e.params.buf,offset:e.params.offset,len:n},a=[e.params.buf];break}case r.readAll.name:{let r=t.readAll();e.result=r.buffer,a=[r.buffer];break}case r.readAllString.name:{let r=t.readAll();e.result=o(r.buffer);break}case r.seek.name:l(e.params.from),c(e.params.offset),e.result=t.seek(e.params.from,e.params.offset)}a?postMessage(e,a):postMessage(e)}(r,d)}}catch(e){r.error=e,postMessage(r)}}}]);
//# sourceMappingURL=worker.js.map