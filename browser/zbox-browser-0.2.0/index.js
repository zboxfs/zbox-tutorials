!function(e,r){if("object"==typeof exports&&"object"==typeof module)module.exports=r();else if("function"==typeof define&&define.amd)define([],r);else{var t=r();for(var n in t)("object"==typeof exports?exports:e)[n]=t[n]}}(window,function(){return function(e){var r={};function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)t.d(n,o,function(r){return e[r]}.bind(null,o));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=0)}([function(e,r,t){"use strict";t.r(r);var n={zbox:{initEnv:{name:"initEnv",arg:[{debug:{type:"boolean",optional:!0}}],optional:!0},version:{name:"version",arg:[]},exists:{name:"exists",arg:["string"]},openRepo:{name:"openRepo",arg:[{uri:{type:"string"},pwd:{type:"string"},opts:{type:"object",optional:!0}}]},repairSuperBlock:{name:"repairSuperBlock",arg:[{uri:{type:"string"},pwd:{type:"string"}}]}},repo:{close:{name:"close",arg:[]},info:{name:"info",arg:[]},resetPassword:{name:"resetPassword",arg:[{oldPwd:{type:"string"}},{newPwd:{type:"string"}}]},pathExists:{name:"pathExists",arg:["string"]},isFile:{name:"isFile",arg:["string"]},isDir:{name:"isDir",arg:["string"]},createFile:{name:"createFile",arg:["string"]},openFile:{name:"openFile",arg:["string",{path:{type:"boolean"},opts:{type:"object",optional:!0}}]},createDir:{name:"createDir",arg:["string"]},createDirAll:{name:"createDirAll",arg:["string"]},readDir:{name:"readDir",arg:["string"]},metadata:{name:"metadata",arg:["string"]},history:{name:"history",arg:["string"]},copy:{name:"copy",arg:[{from:{type:"string"}},{to:{type:"string"}}]},removeFile:{name:"removeFile",arg:["string"]},removeDir:{name:"removeDir",arg:["string"]},removeDirAll:{name:"removeDirAll",arg:["string"]},rename:{name:"rename",arg:[{from:{type:"string"}},{to:{type:"string"}}]}},file:{close:{name:"close",arg:[]},read:{name:"read",arg:["buffer"]},readAll:{name:"readAll",arg:[]},readAllString:{name:"readAllString",arg:[]},write:{name:"write",arg:["string","buffer"]},finish:{name:"finish",arg:[]},writeOnce:{name:"writeOnce",arg:["string","buffer"]},seek:{name:"seek",arg:[{from:{type:"number"},offset:{type:"number"}}]},setLen:{name:"setLen",arg:["number"]},currVersion:{name:"currVersion",arg:[]},metadata:{name:"metadata",arg:[]},history:{name:"history",arg:[]},versionReader:{name:"versionReader",arg:["number"]}},versionReader:{close:{name:"close",arg:[]},read:{name:"read",arg:["buffer"]},readAll:{name:"readAll",arg:[]},readAllString:{name:"readAllString",arg:[]},seek:{name:"seek",arg:[{from:{type:"number"},offset:{type:"number"}}]}}};const o=1,s=2,a=3,i=4,l=5,c=99;let u=new class{constructor(e){this.level=e||i}setLevel(e){switch(e){case"trace":return this.level=o,e;case"debug":return this.level=s,e;case"info":return this.level=a,e;case"warn":return this.level=i,e;case"error":return this.level=l,e;case"off":return this.level=c,e;default:return this.level=i,"warn"}}trace(e){this.level<=o&&console.log(e)}debug(e){this.level<=s&&console.debug(e)}info(e){this.level<=a&&console.info(e)}warn(e){this.level<=i&&console.warn(e)}error(e){this.level<=l&&console.error(e)}};function f(e){return null!==e&&"object"==typeof e}t.d(r,"Zbox",function(){return k});const p={resolver:null,worker:null};function d(e){return"string"==typeof e?"string":"number"==typeof e?"number":(r=e)&&r.buffer instanceof ArrayBuffer&&void 0!==r.byteLength?"buffer":e instanceof ArrayBuffer?"buffer":f(e)?"object":void 0===e?"undefined":"other";var r}class m{constructor(e){this.scope=e}_bindMsg(e,r,t){const o={scope:this.scope,type:e,object:r,params:t},s=d(t),a=n[this.scope][e].arg,i=n[this.scope][e].optional,l=a.find(e=>{const r=f(e)?"object":e;return s===r});if(void 0===l&&a.length>0&&!i)return Promise.reject(new Error("Wrong argument"));if("object"===s&&f(l)){if(Object.keys(l).some(e=>{return!l[e].optional&&!t.hasOwnProperty(e)}))return Promise.reject(new Error("Wrong argument"))}"initEnv"===e&&u.setLevel(o.params?o.params.logLevel:"warn");let c=void 0;if("read"===e||"write"===e||"writeOnce"===e){let e=t.buffer||t;"string"===s&&(e=function(e){for(var r=new ArrayBuffer(2*e.length),t=new Uint16Array(r),n=0,o=e.length;n<o;n++)t[n]=e.charCodeAt(n);return r}(t)),o.params={buf:e,offset:t.byteOffset||0,len:t.byteLength},c=[e]}const m=this;return new Promise((r,t)=>{p.resolver.add(m.scope,e,r,t),p.worker.postMessage(o,c)})}}class g extends m{constructor(){super("repo"),Object.keys(n[this.scope]).forEach(e=>{g.prototype[e]=this._bindMsg.bind(this,e,null)})}}class b extends m{constructor(e){super("file"),this.fd=e,Object.keys(n[this.scope]).forEach(e=>{b.prototype[e]=this._bindMsg.bind(this,e,this.fd)})}}class y extends m{constructor(e){super("versionReader"),this.vrdr=e,Object.keys(n[this.scope]).forEach(e=>{y.prototype[e]=this._bindMsg.bind(this,e,this.vrdr)})}}class h{constructor(){this.map=Object.keys(n).reduce((e,r)=>(e[r]=Object.keys(n[r]).reduce((e,r)=>(e[r]={resolve:null,reject:null},e),{}),e),{})}add(e,r,t,n){this.map[e][r]={resolve:t,reject:n}}resolve(e){const r=e.data;if(r.error){const e=new Error(r.error);return void this.map[r.scope][r.type].reject(e)}const t=n[r.scope];let o=r.result;switch(r.scope){case"zbox":switch(r.type){case t.openRepo.name:o=new g}break;case"repo":switch(r.type){case t.openFile.name:case t.createFile.name:o=new b(o)}break;case"file":switch(r.type){case t.read.name:o=new Uint8Array(o.buf,o.offset,o.len);break;case t.readAll.name:o=new Uint8Array(o);break;case t.versionReader.name:o=new y(o)}break;case"versionReader":switch(r.type){case t.read.name:o=new Uint8Array(o.buf,o.offset,o.len);break;case t.readAll.name:o=new Uint8Array(o)}}this.map[r.scope][r.type].resolve(o)}}const w=document.currentScript.src.replace(/index.js$/,"worker.js"),v=(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1})();class k extends m{constructor(){if(super("zbox"),!v)throw"Your browser doesn't support WebAssembly";if(!window.Worker)throw"Your browser doesn't support Worker";if(!window.indexedDB)throw"Your browser doesn't support IndexedDB";p.resolver=new h,p.worker=new Worker(w,{name:"ZboxWorker"}),p.worker.onmessage=p.resolver.resolve.bind(p.resolver),p.worker.onerror=(e=>{u.error(`ZboxFS worker error: ${JSON.stringify(e)}`)}),Object.keys(n[this.scope]).forEach(e=>{k.prototype[e]=this._bindMsg.bind(this,e,null)})}static get SeekFrom(){return{Start:0,End:1,Current:2}}exit(){return p.worker&&(p.worker.terminate(),p.worker=null,u.info("ZboxFS exited")),Promise.resolve()}}}])});
//# sourceMappingURL=index.js.map